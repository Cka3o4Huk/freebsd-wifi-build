#!/bin/sh

SCRIPT_DIR="$(dirname `realpath $0`)"

# suck in the per-device options
CFGNAME=$1
. ${SCRIPT_DIR}/../cfg/${CFGNAME} || exit 1

MFSROOT_SUID_ROOT=""

MFSROOT_LIB_ROOT=""

MFSROOT_BIN_FILES="
		bin/cfg_load
		bin/cfg_save
		etc/rc
		c/etc/rc.d/base/srv
		c/etc/rc.d/base/sysctl
		c/etc/rc.d/srv/inetd
		c/etc/rc.subr
		c/etc/rc2
		c/etc/state/openvpn-down
		c/etc/state/openvpn-up"

MFSROOT_FILE_FILES="
		c/etc/inetd.conf
		c/etc/gettytab
		c/etc/passwd
		c/etc/master.passwd
		c/etc/group
		c/etc/cfg/manifest
		c/etc/rc.conf.default
		boot/loader.conf
		"

MFSROOT_BIN_ROOT="bin/cat
		bin/chmod
		bin/cp
		bin/csh
		bin/date
		bin/dd
		bin/df
		bin/expr
		bin/hostname
		bin/kenv
		bin/ln
		bin/ls
		bin/mkdir
		bin/mv
		bin/pgrep
		bin/rm
		bin/sh
		bin/sleep

		libexec/resolvconf/libc

		sbin/dmesg
		sbin/init
		sbin/reboot
		
		sbin/sha1
		sbin/shutdown
		sbin/sysctl
		
		
		usr/bin/cap_mkdb
		usr/bin/clear
		usr/bin/cmp
		usr/bin/ee
		usr/bin/false
		usr/bin/find
		usr/bin/grep
		usr/bin/head
		usr/bin/hexdump
		usr/bin/logger
		usr/bin/more
		usr/bin/reset
		usr/bin/tail

		usr/bin/tftp
		usr/bin/touch
		usr/bin/tput
		usr/bin/true
		usr/bin/uname
		usr/bin/uptime

		usr/bin/wall

		usr/libexec/getty

		usr/sbin/chown
		usr/sbin/inetd
		usr/sbin/pwd_mkdb
"

### Options sorted in alpha order
#X_MFS_ARCHIVE="no"
#X_MFS_ATHEROS="no"
#X_MFS_AUTH="yes"
#X_MFS_CRON="no"
#X_MFS_DEV="no"
#X_MFS_FS="no"
#X_MFS_DIAG="no"
#X_MFS_DIAG_NET="no"
#X_MFS_ETH="no"
#X_MFS_FAT="no"
#X_MFS_FW="no"
#X_MFS_GPIO="no"
#X_MFS_KLD="no"
#X_MFS_LOG="no"
#X_MFS_NET="no"
#X_MFS_NTP="no"
#X_MFS_PCI="no"
#X_MFS_SFTP="no"
#X_MFS_STAT="no"
#X_MFS_TELNET="no"
#X_MFS_USB="no"
#X_MFS_WLAN="no"

#ARCHIVE
if [ "${X_MFS_ARCHIVE}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/bin/cpio
		usr/bin/gzip
		usr/bin/tar"
		
${INSTALL_DEF_LINK} /usr/bin/gzip ${X_STAGING_FSROOT}/usr/bin/gunzip
fi

#ATHEROS
if [ "${X_MFS_ATHEROS}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/local/bin/ath_ee_9300_print
		usr/local/bin/ath_ee_v14_print
		usr/local/bin/ath_ee_v4k_print
		usr/local/bin/ath_prom_read
		usr/local/bin/athaggrstats
		usr/local/bin/athdebug
		usr/local/bin/athdecode
		usr/local/bin/athkey
		usr/local/bin/athpeek
		usr/local/bin/athpoke
		usr/local/bin/athradar
		usr/local/bin/athratestats
		usr/local/bin/athrd
		usr/local/bin/athregs
		usr/local/bin/athspectral
		usr/local/bin/athstats
		usr/local/bin/athsurvey"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/net/ath"
fi

#AUTH - authentification: login, passwd
if [ "${X_MFS_AUTH}" = "yes" ]; then
	MFSROOT_SUID_ROOT="${MFSROOT_SUID_ROOT}
		usr/bin/login
		usr/bin/passwd
		usr/bin/su
		"
		
	MFSROOT_FILE_FILES="${MFSROOT_FILE_FILES}
		c/etc/pam.d/atrun
		c/etc/pam.d/ftp
		c/etc/pam.d/ftpd
		c/etc/pam.d/imap
		c/etc/pam.d/kde
		c/etc/pam.d/passwd
		c/etc/pam.d/pop3
		c/etc/pam.d/rsh
		c/etc/pam.d/sshd
		c/etc/pam.d/su
		c/etc/pam.d/xdm
		c/etc/pam.d/login
		c/etc/pam.d/telnetd
		c/etc/pam.d/other
		c/etc/pam.d/system
		"
	MFSROOT_LIB_ROOT="${MFSROOT_LIB_ROOT}
		usr/lib/pam_self.so
		usr/lib/pam_nologin.so
		usr/lib/pam_unix.so
		usr/lib/pam_login_access.so
		usr/lib/pam_lastlog.so
		"
fi

#CRON
if [ "${X_MFS_CRON}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/cron"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/srv/cron"

	MFSROOT_FILE_FILES="${MFSROOT_FILE_FILES}
		c/etc/crontab
		c/etc/pam.d/cron"
fi

#NTP
if [ "${X_MFS_NTP}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/ntpdate"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/srv/ntpdate"
fi

#DEV
if [ "${X_MFS_DEV}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/devctl
		usr/sbin/devinfo"
fi

#DHCP
if [ "${X_MFS_DHCP}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/dhclient
		sbin/dhclient-script"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/srv/cron"

	MFSROOT_FILE_FILES="${MFSROOT_FILE_FILES}
		c/etc/dhclient-enter-hooks
		c/etc/dhclient-exit-hooks"

	${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/dhclient.conf ${X_STAGING_FSROOT}/c/etc
fi
#FS
if [ "${X_MFS_FS}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/fsck
		sbin/fsck_ffs
		sbin/fsck_ufs
		sbin/mdconfig
		sbin/mount
		sbin/mount_mfs
		sbin/newfs
		sbin/umount"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}"

	MFSROOT_FILE_FILES="${MFSROOT_FILE_FILES}
		etc/fstab"
fi
#DIAG
if [ "${X_MFS_DIAG}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/bin/ktrdump
		usr/bin/ktrace
		usr/bin/truss"
fi

#DIAG_NET
if [ "${X_MFS_DIAG_NET}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/tcpdump"
fi

#ETH
if [ "${X_MFS_ETH}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/etherswitchcfg
		sbin/ifconfig"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		sbin/ifdown
		sbin/ifup
		c/etc/rc.d/base/net
		c/etc/rc.d/net/bridge
		c/etc/rc.d/net/ether
		c/etc/rc.d/net/etherswitch
		c/etc/rc.d/net/vlan"
fi
#FAT
if [ "${X_MFS_FAT}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/mount_msdosfs"
fi
#FW
if [ "${X_MFS_FW}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/ipfw"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/base/firewall"
fi
#GPIO
if [ "${X_MFS_GPIO}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/gpioctl"
fi
#KLD
if [ "${X_MFS_KLD}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/kldload
		sbin/kldstat
		sbin/kldunload"
fi
#LOG
if [ "${X_MFS_LOG}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/syslogd"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/srv/syslogd"

	MFSROOT_FILE_FILES="${MFSROOT_FILE_FILES}"
fi
#NET
if [ "${X_MFS_NET}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		sbin/ping
		sbin/route
		sbin/resolvconf
		usr/bin/nc
		usr/sbin/arp"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/base/routing"
fi
#PCI
if [ "${X_MFS_PCI}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/pciconf"
fi
#SFTP
if [ "${X_MFS_SFTP}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/bin/sftp"
fi
#STAT
if [ "${X_MFS_STAT}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		bin/ps
		usr/bin/top
		usr/bin/netstat
		usr/bin/procstat
		usr/bin/systat
		usr/bin/vmstat
		usr/sbin/pmccontrol
		usr/sbin/pmcstat
		usr/sbin/prometheus_sysctl_exporter"
fi
#TELNET
if [ "${X_MFS_TELNET}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/bin/telnet
		usr/libexec/telnetd"
fi
#USB
if [ "${X_MFS_USB}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/sbin/usbconfig"
fi
#WLAN
if [ "${X_MFS_WLAN}" = "yes" ]; then
	MFSROOT_BIN_ROOT="${MFSROOT_BIN_ROOT}
		usr/local/bin/wlanstats
		usr/local/bin/wlanwatch
		usr/local/bin/wlanwds
		
		usr/sbin/hostapd
		usr/sbin/hostapd_cli
		usr/sbin/wlandebug
		usr/sbin/wpa_cli
		usr/sbin/wpa_supplicant"

	MFSROOT_BIN_FILES="${MFSROOT_BIN_FILES}
		c/etc/rc.d/net/wifi
		c/etc/rc.hostapd
		c/etc/rc.wpa_ibss"

	MFSROOT_FILE_FILES="${MFSROOT_FILE_FILES}"

${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/regdomain.xml ${X_STAGING_FSROOT}/c/etc/
fi

. ${SCRIPT_DIR}/build_mfscommon $1 || exit 1

${INSTALL_DEF_LINK} /usr/bin/more ${X_STAGING_FSROOT}/usr/bin/less

#libexec
${INSTALL_DEF_LIB} ${X_DESTDIR}/libexec/ld-elf.so.1 ${X_STAGING_FSROOT}/libexec/

#base to c/etc
${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/nsswitch.conf ${X_STAGING_FSROOT}/c/etc/nsswitch.conf
${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/login.conf ${X_STAGING_FSROOT}/c/etc/
${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/services ${X_STAGING_FSROOT}/c/etc/
${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/protocols ${X_STAGING_FSROOT}/c/etc/
# this is needed for inetd
${INSTALL_DEF_FILE} ${X_DESTDIR}/etc/netconfig ${X_STAGING_FSROOT}/c/etc/

${INSTALL_DEF_FILE} ${X_DESTDIR}/usr/share/misc/termcap ${X_STAGING_FSROOT}/usr/share/misc/
${INSTALL_DEF_FILE} ${X_DESTDIR}/usr/share/tabset/vt100 ${X_STAGING_FSROOT}/usr/share/tabset/

echo "${X_ROOTFS_DEV} / ufs rw 1 1" >> ${X_STAGING_FSROOT}/etc/fstab
